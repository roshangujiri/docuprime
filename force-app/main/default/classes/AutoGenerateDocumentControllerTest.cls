@isTest
public class AutoGenerateDocumentControllerTest {
    @isTest
    public static void testautoGenerateDocumentFromTemplateBulkified() {
        User docupadUser = TestUtils.generateDocuPadUserForTest();
        System.runAs(docupadUser) {
            List<Account> accList = TestDataFactory.createAccounts(1, 'Test Account', true); 
            Account acc = accList[0];
            List<Contact> contList = TestDataFactory.createContactsWithAccount(1, 'Test Contact', acc.Id, true);
            Contact cont = contList[0];
            cont.Birthdate = System.today();
            UPDATE cont;
            contList.add(cont);
            List<Document_Template__c> tempList = TestDataFactory.createTemplates(1, 'test template', ' ', true);
            List<Document_Content__c> sectionList = TestDataFactory.createSections(6, 'Section', tempList[0].Id, true);
            List<Document_Content__c> fieldList = TestDataFactory.createFields(6,'Field', sectionList, true);
            List<Document_Content__c> documentContentupdateList = new List<Document_Content__c>();
            List<Document_Content__c> sectionListToUpdate = new List<Document_Content__c>();
            Document_Content__c documentContent = fieldList[0];
            documentContent.Reference_Field__c = 'Contact.Birthdate';
            documentContentupdateList.add(documentContent);
            Document_Content__c documentContentWithUserFeild = fieldList[1];
            documentContentWithUserFeild.Reference_Field__c = '$User.Email';
            documentContentupdateList.add(documentContentWithUserFeild);
            Document_Content__c documentContentWithOrgDetails = fieldList[2];
            documentContentWithOrgDetails.Reference_Field__c = '$Organization.Name';
            documentContentupdateList.add(documentContentWithOrgDetails);
            Document_Content__c documentContentWithSettings = fieldList[3];
            documentContentWithSettings.Reference_Field__c = '$Settings.Document_Esign__c.Esign_Webhook_URL__c';
            documentContentupdateList.add(documentContentWithSettings);
            Document_Content__c documentContentWithCustomMeataData = fieldList[4];
            documentContentWithCustomMeataData.Reference_Field__c = '$Metadata.Custom_Setting__mdt.My Last Name.Name__c';
            documentContentupdateList.add(documentContentWithCustomMeataData);
            UPDATE documentContentupdateList;
            fieldList.add(documentContent);
            fieldList.add(documentContentWithUserFeild);
            fieldList.add(documentContentWithOrgDetails);
            fieldList.add(documentContentWithSettings);
            fieldList.add(documentContentWithCustomMeataData);
            for(Document_Content__c section : sectionList) {
                if(section.Order_Sequence__c ==2) {
                    section.Section_Content__c = '<p style="text-align: center;"><b><i>TEST CONTENT [Field-1] </i>';
                } else if(section.Order_Sequence__c ==3) {
                    section.Section_Content__c = '<p style="text-align: center;"><b><i>TEST CONTENT [Field-2] </i>';
                    
                } else if(section.Order_Sequence__c ==4) {
                    section.Section_Content__c = '<p style="text-align: center;"><b><i>TEST CONTENT [Field-3] </i>'; 
                } else if(section.Order_Sequence__c ==5) {
                    section.Section_Content__c = '<p style="text-align: center;"><b><i>TEST CONTENT [Field-4] </i>'; 
                }
                sectionListToUpdate.add(section);
            }
            UPDATE sectionListToUpdate;
            sectionList.add(sectionListToUpdate[0]);
            sectionList.add(sectionListToUpdate[1]);
            sectionList.add(sectionListToUpdate[2]);
            sectionList.add(sectionListToUpdate[3]);
            List<AutoGenerateDocumentWrapper> dataList = new List<AutoGenerateDocumentWrapper>();
            AutoGenerateDocumentWrapper wrapper = new AutoGenerateDocumentWrapper();
            wrapper.recordId = contList[0].Id;
            wrapper.templateName = tempList[0].Name;
            wrapper.attachDocument = true;
            wrapper.sendForEsign = true;
            dataList.add(wrapper);
            Document_Template__c doctemplate = tempList[0];
            doctemplate.Additional_Info__c = '{"approverNameRef":"Contact.Name","approverEmailRef":"Contact.Email"}';
            UPDATE doctemplate; 
            tempList.add(doctemplate);
            AutoGenerateDocumentController.autoGenerateDocumentFromTemplate(dataList);
            Corporate_Document__c cropDoc = [SELECT Id, Name 
                                            FROM Corporate_Document__c 
                                            WHERE Name = 'test template0 - Test Contact0' 
                                            LIMIT 1];
            System.assert(cropDoc != Null);
        }
    }
}